# 计算机网络

## 计算机网络体系结构

* 计算机网络：一些互联的，自治的计算机系统的集合
* 物理组成：硬件，软件，协议；功能组成：通信子网，资源子网
* **数据通信** 是计算机网络最基本和最重要的功能
* 资源共享，网络资源包括硬件资源，软件资源和数据资源
* 按分布分类：WAN, MAN, LAN, PAN
* 广域网是因特网的核心部分，使交换技术，局域网使用广播技术
* **协议** 是对等实体进行通信的规则的集合（水平的）
* **服务** 是下层通过 **接口** 为相邻的上层提供的功能调用（垂直的）
* 体系结构（上 -> 下）：
  * OSI 七层模型：应用层->表示层->会话层->传输层->网络层->数据链路层->物理层
  * 五层模型：应用层->传输层->网络层->数据链路层->物理层
  * TCP/IP 四层模型：应用层-运输层-网际层-网络接口层
* 总时延 = 发送（传输）时延 + 传播时延 + 处理时延 + 排队时延
* 信道利用率：信道有百分之多少的时间是被利用的
* 吞吐量：单位时间内通过某个网络（接口，信道）的数据量

## 物理层

* **数据**（data）是指传送**信息**（message）的实体，**信号**（signal）是数据的电气或电磁的表现
* 采样定理：将模拟信号转换为数字信号是，采样频率 $f_c >= 2f$ （f 为原始信号的最大频率）
* 奈氏准则：$C_{max} = 2Wlog_2V = f_clog_2V$，W 为带宽（Hz），V 为每码元离散电平个数，$C_{max}$ 为信道极限传输率，适用于无噪声情况
* 信噪比：$10log_{10}(S/N)$ (dB)
* 香农公式：$C_{max} = Wlog_2(1+S/N)$，适用于有噪声情况
* 调制：数据 -> 模拟信号；编码：数据 -> 数字信号
* 波特率：信号每秒变化的次数，比特率 = 波特率 * log2n
* 以太网采用曼彻斯特编码，每 bit 需要两个电平，数据率 = 0.5 * 波特率
* **放大器** 放大模拟信号，**中续器** 放大数字信号，两端需速率相同，协议相同，**集线器**（hub）是一种多端口中续器
* 有存储转发功能的设备可以连接两个不用的协议，但本层以上的协议必须相同

## 数据链路层

* 功能：组帧，差错控制，流量控制等
* 组帧的比特填充法：遇到 5 个连续的 1 就插入一个 0
* [滑动窗口流量控制技术](https://blog.yfxie.com/comparison-of-network-gbn-sr-and-tcp/)
  * GBN（Go-Back-N)，$1 <= W_T <=2^n-1$，采用 **累计确认**
  * SR (Selective Repeat)，$W_R + W_T <= 2^n, W_{Rmax}=W_{Tmax}=2^{n-1}$，ack 分组不再具有累计确认的作用
* 要使信道利用率达到最高，需要在一个周期内发送尽可能多的帧
* 信道划分截止访问控制：FDM，TDM，WDM，CDM
* 随机访问截止访问控制（争用型协议）：ALOHA，CSMA(1/p/非)
  * CSMA/CD：载波监听多点接入 / 碰撞检测，碰撞时采用截断二进制指数退避算法，争用期 2τ；“所有站点都能听见对方”是实现 CSMA/CD 必备的基础；适用于有线网络
  * CSMA/CA：载波监听多点接入 / 碰撞避免，广泛应用于无线局域网，在无线局域网中，即使发送过程中发生了碰撞，也要把整个帧发送完毕
* 最短帧长 = 传输速率 * 2τ
* 以太网 V2 MAC 帧格式，单位为字节

  |目的地址|源地址|类型|数据（IP 数据报）|FCS|
  |---|---|---|---|---|
  |6|6|2|46~1500|4|

* 高速以太网：数据传输率达到或超过 100Mb/s 的以太网，保留了以太网的最小帧长格式
* 广域网是一个单一的网络（点对点通信方式），使用结点交换机连接各主机，互联网使用路由器连接各网络
* PPP 协议是面向字节的，HDLC 协议是面向比特的
* 流量控制对数据链路层来说控制的是相邻两结点之间数据链路上的流量，对于运输层来说控制的则是从源端到目的端之间的流量
* 网桥工作在数据链路层，可以使以太网各段成为隔离开的碰撞域
* 透明网桥不一定选择最佳路由，源路由网桥选择最佳路由
* 以太网交换机是一个多端口网桥

## 网络层

* 功能：网络互联；路由和转发；拥塞控制
* 网络互联通知是指用路由器进行网络互联和路由选择
* 路由器的两大核心功能：路由选择和分组转发
* IP 数据报格式：
   ![image](https://raw.githubusercontent.com/csJd/res/master/pic/85c05fb1-5546-4c50-9221-21f231cdc8c5.1ca155j5ug8.jpg)
* IP 数据报中首部长度以 **4B** 为单位，总长度以 **1B** 为单位，片偏移以 **8B** 为单位；协议字段 6 表示 TCP，17 表示 UDP，1 表示 ICMP；总长度小于 46B 的数据报帧必须填充至 46B
* IP 地址主机号全 0 表示本网络的网络地址（不能用作源地址或目的地址），主机号全 1 表示本网络的广播地址，网络号全 0 表示表示本网络，主机号和网络号都全为 0 则表示本网络上的本主机，只能用作源地址，网络号为 127 表示换回测试地址
* 0 - A ~ 128 - B ~ 192 - C ~ 224 - D ~ 240 - E -
* 专用地址： A: 10.-.-.-, B: 172.16.0.0 - 172.31.255.255, C: 192.168.-.-
* 最长前缀匹配：使用 CIDR 时，应从匹配结果中选择具有最长网络前缀的路由
* PING 使用了 ICMP 的询问报文中的会送请求和回答报文
* IPv6 不允许分片，具有更简单的 IP 数据报头（只含 8 个字段），没有校验和
* 分组和排序由传输层完成，分段（片）和重组由网络层完成
* 路由协议：
  * RIP：跳数最少，按固定时间间隔和相邻路由器交换全部信息，距离向量，UDP
  * OSPF：代价最低（Dijkstra），链路状态发生变化时向本 AS 中所有路由器发送部分信息，链路状态，IP
  * BGP：外部，首次交换整个路由表，以后只交换有变化的部分，与相邻的交换，路径向量，TCP
* 路由器是一种具有多个输入输出端口的专用计算机，其任务是连接不同的网络并完成转发
  * **路由表** 是根据路由选择算法由路由选择处理机得出的，一般含有目的 IP 地址，子网掩码，下一跳 IP 地址，接口
  * **转发表** 是从路由表得出的，其表项和路由表有直接对应关系，分组转发是直接查找转发表，一般含有目的地址和下一跳
* 到互联网的路由实质上相当于一个默认路由，即 0.0.0.0/0
* 本地广播地址：255.255.255.255 所有本地主机都能收到，路由器不转发
* 直接广播地址：主机号全 1，用于任何网络向该网络上所有主机发送广播报文

## 传输层

* 功能：逻辑通信，复用和分用，差错检测，面向连接的 TCP 和面向无连接的 UDP
* 传输层只存在于通信子网以外的主机中，提供端到端的逻辑通信
* UDP 数据报首部 |源端口|目的端口|长度|校验和| 各 2B
* UDP 的校验和不是必须的，不使用时校验和字段设为 0
* TCP 首部长度 20B~60B，数据偏移字段以 4B 为单位
* TCP 是面向字节流的，序号字段的值是本报文段发送数据的第一个字节的序号
* SYN = 1 表示这是一个连接请求报文（ACK=0），或连接接受报文（ACK=1）
* “三次握手”建立 TCP 连接
  1. C->S: `SYN = 1, seq = x`
  2. C<-S: `SYN = 1, ACK = 1, seq = y, ack = x+1`
  3. C->S: `ACK = 1, seq = x+1, ack = y+1`
  * 1 和 2 不携带数据，消耗一个序号，3 可以携带数据，不携带则不消耗序号
* “四次挥手”释放 TCP 连接
  1. C->S: `FIN = 1, seq = u`
  2. S->C: `ACK = 1, seq = v, ack = u+1`
  3. S->C: `FIN = 1, ACK = 1, seq = w, ack = u+1`
  4. C->S: `ACK = 1, seq = u+1, ack = w+1`
* TCP 确认号是对字节的，确认是对报文段的，确认号是期待收到的下一个报文段的第一字节的序号
* 流量控制：发送窗口大小 $swnd = min\{rwnd, cwnd\}$, cwnd 为拥塞窗口
* 拥塞控制
  * 慢开始：$cwnd = 1$，$cwnd$ 指数增长直到达到 $ssthresh$
  * 拥塞避免：$cwnd$ 加法增大，若检测到超时：$ssthresh = cwnd/2, cwnd = 1$，慢开始
  * 收到 3 个重复 ACK：快重传（直接重传对方未收到的报文段）；快恢复，$ssthresh = cwnd = cwnd/2$
